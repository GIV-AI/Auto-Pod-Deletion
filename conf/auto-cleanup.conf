#!/bin/bash
# ============================================================================
# Auto-Cleanup Configuration
# ============================================================================
# Configuration file for the Auto-Cleanup tool.
# This file is sourced by the main script, so use valid Bash syntax.
#
# Location (in order of precedence):
#   1. /etc/auto-cleanup/auto-cleanup.conf (installed)
#   2. <script_dir>/../conf/auto-cleanup.conf (development)
# ============================================================================

# ============================================================================
# RESOURCE ENABLE/DISABLE
# ============================================================================
# Set to "true" or "false" to enable/disable cleanup for each resource type

Deployment=true
Pod=true
Service=true

# ============================================================================
# LIMIT TYPE SWITCHES
# ============================================================================
# Enable/disable hard and soft limits per resource type.
# If both HardLimit and SoftLimit are disabled for a resource, that resource
# type will be skipped entirely.
#
# Hard Limit: Always deletes when age exceeds limit (ignores keep-alive label)
# Soft Limit: Respects keep-alive=true label; deletes only if not set/false

Deployment_HardLimit=true
Deployment_SoftLimit=true

Pod_HardLimit=true
Pod_SoftLimit=true

Service_HardLimit=true
Service_SoftLimit=true

# ============================================================================
# USER TYPE LIMITS
# ============================================================================
# Time limits are determined by namespace prefix:
#   - dgx-s-* (Student namespaces)
#   - dgx-f-* (Faculty namespaces)
#   - dgx-i-* (Industry namespaces)
#
# Time format: Use D suffix for days, H suffix for hours, M suffix for minutes.
#   - Examples: 7D = 7 days, 2H = 2 hours, 30M = 30 minutes
#   - No suffix defaults to minutes (e.g., 30 = 30 minutes)
#   - Case-insensitive: 7d, 7D, 2h, 2H, 30m, 30M are all valid

# --- STUDENT LIMITS (dgx-s*) ---
STUDENT_SOFT=24H
STUDENT_HARD=36H

# --- FACULTY LIMITS (dgx-f*) ---
FACULTY_SOFT=36H
FACULTY_HARD=84H

# --- INDUSTRY LIMITS (dgx-i*) ---
INDUSTRY_SOFT=84H
INDUSTRY_HARD=168H

# ============================================================================
# POD DELETION BEHAVIOR
# ============================================================================
# Pods are queued and deleted in batches for efficiency.
# Background execution enables parallel deletion across multiple namespaces.

# Batch size: Number of pods to delete in a single kubectl command
# Higher values reduce API calls but increase memory per kubectl process
# Recommended: 25-100 depending on cluster size
POD_BATCH_SIZE=50

# Force delete: Use --grace-period=0 --force (immediate termination)
# WARNING: This skips graceful shutdown. Use only if pods are stuck terminating.
POD_FORCE_DELETE=false

# Background delete: Run kubectl delete in background (don't wait)
# When enabled, deletions across different namespaces run in parallel
POD_BACKGROUND_DELETE=true

# Maximum concurrent kubectl delete processes (only applies when POD_BACKGROUND_DELETE=true)
# Prevents resource exhaustion when deleting pods across many namespaces
# Too high: May overwhelm API server and consume excessive memory/file descriptors
# Too low: Reduces parallelism benefits
# Recommended: 5-20 depending on cluster capacity and node resources
# Do not put any suffix to the value like s, m, h, d, etc.
MAX_CONCURRENT_DELETES=20

# Timeout for individual kubectl delete commands (in seconds)
# Prevents hung kubectl processes from blocking cleanup indefinitely
# If a kubectl command runs longer than this, it will be killed
# Should be longer than expected pod termination time (including finalizers)
# Recommended: 300-600 seconds (5-10 minutes)
# Do not put any suffix to the value like s, m, h, d, etc.
KUBECTL_TIMEOUT=600

# Maximum time to wait for a background kubectl process to finish (in seconds)
# When MAX_CONCURRENT_DELETES processes are running, the script waits for one to complete
# before starting a new deletion. If all processes hang and none finish within this timeout,
# the script proceeds anyway to avoid deadlock (may temporarily exceed MAX_CONCURRENT_DELETES)
# Should be >= KUBECTL_TIMEOUT * 2 to allow hung processes to be killed first
# Recommended: 600-1200 seconds (10-20 minutes)
# Do not put any suffix to the value like s, m, h, d, etc.
WAIT_LOOP_TIMEOUT=1200

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================
# Log directory (day-wise files: auto-cleanup-YYYY-MM-DD.log)
LOG_DIR="/var/log/giindia/auto-cleanup"

# Log level: DEBUG, INFO, WARNING, ERROR
LOG_LEVEL=INFO

# Maximum log file size in bytes (10MB default)
MAX_LOG_SIZE=10485760

# Log retention in days (older logs are auto-deleted)
LOG_RETENTION_DAYS=30

